# Notification System - High Level Design

## Table of Contents
1. [System Requirements](#system-requirements)
2. [Capacity Estimation](#capacity-estimation)
3. [High-Level Design](#high-level-design)
4. [Request Flows](#request-flows)
5. [Detailed Component Design](#detailed-component-design)
6. [Trade-offs and Tech Choices](#trade-offs-and-tech-choices)
7. [Failure Scenarios and Bottlenecks](#failure-scenarios-and-bottlenecks)
8. [Future Improvements](#future-improvements)
9. [Interviewer Questions & Answers](#interviewer-questions--answers)

---

## System Requirements

### Functional Requirements

1. **Multi-Channel Delivery**
   - Push notifications (iOS/Android)
   - Email notifications
   - SMS notifications
   - In-app notifications
   - Web push notifications

2. **Notification Types**
   - Transactional (order confirmation, password reset)
   - Marketing/Promotional
   - System alerts
   - Social (likes, comments, follows)

3. **User Preferences**
   - Channel preferences (email/push/SMS)
   - Frequency settings (immediate/daily digest)
   - Category opt-in/opt-out
   - Quiet hours

4. **Template Management**
   - Customizable templates
   - Multi-language support
   - Dynamic content personalization

5. **Analytics**
   - Delivery tracking
   - Open/click tracking
   - Engagement metrics

### Non-Functional Requirements

1. **Scale**: 10 Billion notifications/day
2. **Availability**: 99.99% uptime
3. **Latency**: <1 minute for immediate, <5 minutes for batched
4. **Reliability**: At-least-once delivery guarantee
5. **Ordering**: Best-effort ordering within channel
6. **Throughput**: Handle 500K+ notifications/second at peak

---

## Capacity Estimation

### Traffic Estimates

```
Notifications:
- Total notifications/day: 10 Billion
- Notifications/second: 10B / 86400 â‰ˆ 115,000/sec
- Peak (3x average): 350,000/sec

Breakdown by channel:
- Push (iOS + Android): 60% â†’ 6B/day
- Email: 25% â†’ 2.5B/day
- In-app: 10% â†’ 1B/day
- SMS: 5% â†’ 500M/day

User base:
- Total users: 500 Million
- Daily active users: 200 Million
- Average notifications/user/day: 50
```

### Storage Estimates

```
Notification Records:
- Each notification: 500 bytes
  - notification_id: 16 bytes
  - user_id: 8 bytes
  - type/channel: 10 bytes
  - content: 300 bytes
  - metadata: ~166 bytes

- Daily storage: 10B * 500 bytes = 5 TB/day
- Retention (30 days): 150 TB

Templates:
- 10,000 templates * 10 KB average = 100 MB

User Preferences:
- 500M users * 1 KB = 500 GB
```

### Bandwidth Estimates

```
Incoming (events):
- 115K/sec * 1 KB = 115 MB/sec

Outgoing (deliveries):
- Push: 70K/sec * 1 KB = 70 MB/sec
- Email: 30K/sec * 50 KB = 1.5 GB/sec
- SMS: 6K/sec * 200 bytes = 1.2 MB/sec

Total: ~2 GB/sec outgoing
```

---

## High-Level Design

### Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              EVENT SOURCES                                           â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Orders   â”‚  â”‚  Social   â”‚  â”‚  Payment  â”‚  â”‚  System   â”‚  â”‚ Marketing â”‚        â”‚
â”‚  â”‚  Service  â”‚  â”‚  Service  â”‚  â”‚  Service  â”‚  â”‚  Alerts   â”‚  â”‚  Service  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â”‚              â”‚              â”‚              â”‚              â”‚              â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                      â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           NOTIFICATION GATEWAY                                       â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         API LAYER                                            â”‚   â”‚
â”‚  â”‚  POST /notifications/send                                                    â”‚   â”‚
â”‚  â”‚  POST /notifications/batch                                                   â”‚   â”‚
â”‚  â”‚  GET  /notifications/status/{id}                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                             â”‚
â”‚                          Validation, Rate Limiting                                 â”‚
â”‚                                      â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              MESSAGE QUEUE (Kafka)                                   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚   High Priority â”‚  â”‚  Medium Priority â”‚  â”‚   Low Priority  â”‚                    â”‚
â”‚  â”‚   (transactional)â”‚  â”‚    (social)     â”‚  â”‚   (marketing)   â”‚                    â”‚
â”‚  â”‚      Topic      â”‚  â”‚      Topic      â”‚  â”‚      Topic      â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          NOTIFICATION PROCESSOR                                      â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Processing Pipeline                                     â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚ Preferenceâ”‚â”€â”€>â”‚ Template  â”‚â”€â”€>â”‚Deduplicationâ”€>â”‚ Rate      â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  Lookup   â”‚   â”‚  Render   â”‚   â”‚   Check   â”‚   â”‚ Limiter   â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CHANNEL ROUTER                                             â”‚
â”‚                                                                                     â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚             â–¼              â–¼              â–¼              â–¼              â–¼          â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚      â”‚   Push    â”‚  â”‚   Email   â”‚  â”‚    SMS    â”‚  â”‚  In-App   â”‚  â”‚ Web Push  â”‚   â”‚
â”‚      â”‚   Queue   â”‚  â”‚   Queue   â”‚  â”‚   Queue   â”‚  â”‚   Queue   â”‚  â”‚   Queue   â”‚   â”‚
â”‚      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚              â”‚              â”‚              â”‚              â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚              â”‚              â”‚              â”‚              â”‚
             â–¼              â–¼              â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DELIVERY WORKERS                                            â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Push Worker  â”‚  â”‚ Email Worker  â”‚  â”‚  SMS Worker   â”‚  â”‚In-App Worker  â”‚       â”‚
â”‚  â”‚               â”‚  â”‚               â”‚  â”‚               â”‚  â”‚               â”‚       â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚
â”‚  â”‚ â”‚   APNs    â”‚ â”‚  â”‚ â”‚ SendGrid  â”‚ â”‚  â”‚ â”‚  Twilio   â”‚ â”‚  â”‚ â”‚ WebSocket â”‚ â”‚       â”‚
â”‚  â”‚ â”‚   FCM     â”‚ â”‚  â”‚ â”‚ SES       â”‚ â”‚  â”‚ â”‚  Nexmo    â”‚ â”‚  â”‚ â”‚  Server   â”‚ â”‚       â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚ Mailgun   â”‚ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  DATA LAYER                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  NOTIFICATION   â”‚   USER PREFS    â”‚   TEMPLATES     â”‚      ANALYTICS                â”‚
â”‚     STORE       â”‚     STORE       â”‚     STORE       â”‚       STORE                   â”‚
â”‚  (Cassandra)    â”‚   (Redis/DB)    â”‚   (PostgreSQL)  â”‚    (ClickHouse)              â”‚
â”‚                 â”‚                 â”‚                 â”‚                               â”‚
â”‚ - History       â”‚ - Channel prefs â”‚ - Templates     â”‚ - Delivery events            â”‚
â”‚ - Status        â”‚ - Quiet hours   â”‚ - Versions      â”‚ - Opens/clicks               â”‚
â”‚ - Retry queue   â”‚ - Categories    â”‚ - Languages     â”‚ - Aggregations               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Core Components

1. **Notification Gateway**: Entry point, validation, routing
2. **Message Queue**: Priority-based queuing (Kafka)
3. **Notification Processor**: Preference lookup, templating, dedup
4. **Channel Router**: Route to appropriate delivery channel
5. **Delivery Workers**: Channel-specific delivery logic
6. **Analytics Pipeline**: Track delivery, opens, clicks

---

## Request Flows

### Send Notification Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚  â”‚ Gateway â”‚  â”‚  Kafka  â”‚  â”‚ Processor â”‚  â”‚  Worker â”‚  â”‚Provider â”‚
â”‚Service â”‚  â”‚   API   â”‚  â”‚         â”‚  â”‚           â”‚  â”‚         â”‚  â”‚(APNs)   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚            â”‚            â”‚             â”‚             â”‚            â”‚
    â”‚ POST       â”‚            â”‚             â”‚             â”‚            â”‚
    â”‚/send       â”‚            â”‚             â”‚            â”‚            â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚             â”‚             â”‚            â”‚
    â”‚            â”‚ Validate   â”‚             â”‚             â”‚            â”‚
    â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€(sync)    â”‚             â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚             â”‚            â”‚
    â”‚            â”‚ Enqueue    â”‚             â”‚             â”‚            â”‚
    â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚             â”‚            â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚             â”‚             â”‚            â”‚
    â”‚ 202 Accepted            â”‚             â”‚             â”‚            â”‚
    â”‚ (notification_id)       â”‚             â”‚             â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚             â”‚            â”‚
    â”‚            â”‚            â”‚ Consume     â”‚             â”‚            â”‚
    â”‚            â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚ Get user    â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚ preferences â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚â”€â”€â”€â”€â”€â”€(DB)   â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚             â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚ Render      â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚ template    â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚             â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚ Route to    â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚ channel     â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚             â”‚ Deliver    â”‚
    â”‚            â”‚            â”‚             â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚            â”‚            â”‚             â”‚             â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚            â”‚            â”‚             â”‚             â”‚ Success    â”‚
    â”‚            â”‚            â”‚             â”‚             â”‚            â”‚
    â”‚            â”‚            â”‚             â”‚ Update status            â”‚
    â”‚            â”‚            â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
```

### Batch Notification Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Marketingâ”‚  â”‚ Gateway â”‚  â”‚  Kafka  â”‚  â”‚  Batch    â”‚  â”‚ Workers â”‚
â”‚ Service â”‚  â”‚   API   â”‚  â”‚         â”‚  â”‚ Processor â”‚  â”‚ (Pool)  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚             â”‚            â”‚             â”‚             â”‚
    â”‚ POST /batch â”‚            â”‚             â”‚             â”‚
    â”‚ (1M users)  â”‚            â”‚             â”‚             â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚             â”‚             â”‚
    â”‚             â”‚ Create job â”‚             â”‚             â”‚
    â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€(DB)      â”‚             â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚             â”‚             â”‚
    â”‚ 202 Acceptedâ”‚            â”‚             â”‚             â”‚
    â”‚ (job_id)    â”‚            â”‚             â”‚             â”‚
    â”‚             â”‚            â”‚             â”‚             â”‚
    â”‚             â”‚ Enqueue jobâ”‚             â”‚             â”‚
    â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚             â”‚
    â”‚             â”‚            â”‚ Process in  â”‚             â”‚
    â”‚             â”‚            â”‚ chunks      â”‚             â”‚
    â”‚             â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
    â”‚             â”‚            â”‚             â”‚ Chunk 1     â”‚
    â”‚             â”‚            â”‚             â”‚ (10K users) â”‚
    â”‚             â”‚            â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚             â”‚            â”‚             â”‚             â”‚
    â”‚             â”‚            â”‚             â”‚ Chunk 2     â”‚
    â”‚             â”‚            â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚             â”‚            â”‚             â”‚             â”‚
    â”‚             â”‚            â”‚             â”‚ ...         â”‚
    â”‚             â”‚            â”‚             â”‚             â”‚
    â”‚             â”‚            â”‚             â”‚ Chunk 100   â”‚
    â”‚             â”‚            â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚             â”‚            â”‚             â”‚             â”‚
    â”‚             â”‚            â”‚             â”‚ Update job  â”‚
    â”‚             â”‚            â”‚             â”‚ progress    â”‚
    â”‚             â”‚            â”‚             â”‚â”€â”€â”€â”€(DB)     â”‚
```

### Preference Check Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Processor   â”‚  â”‚  User     â”‚  â”‚  Redis  â”‚  â”‚ PostgreSQLâ”‚
â”‚             â”‚  â”‚  Prefs    â”‚  â”‚ (Cache) â”‚  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚  Service  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚             â”‚
       â”‚               â”‚             â”‚             â”‚
       â”‚ Get prefs     â”‚             â”‚             â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚             â”‚
       â”‚               â”‚ Check cache â”‚             â”‚
       â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
       â”‚               â”‚             â”‚             â”‚
       â”‚               â”‚ Cache HIT   â”‚             â”‚
       â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚
       â”‚ Preferences   â”‚             â”‚             â”‚
       â”‚               â”‚             â”‚             â”‚
       â”‚ (If MISS)     â”‚             â”‚             â”‚
       â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚               â”‚             â”‚             â”‚
       â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚               â”‚             â”‚             â”‚
       â”‚               â”‚ Update cacheâ”‚             â”‚
       â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚
       â”‚               â”‚             â”‚             â”‚
       â”‚ Check:        â”‚             â”‚             â”‚
       â”‚ - Channel enabled?          â”‚             â”‚
       â”‚ - Category allowed?         â”‚             â”‚
       â”‚ - Quiet hours?              â”‚             â”‚
       â”‚ - Frequency limit?          â”‚             â”‚
```

---

## Detailed Component Design

### 1. Priority Queue System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          PRIORITY QUEUE DESIGN                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  Priority Levels:                                                                   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  P0 (Critical):     OTP, Security alerts, Payment issues                    â”‚   â”‚
â”‚  â”‚                     SLA: < 30 seconds                                        â”‚   â”‚
â”‚  â”‚                     Retry: Immediate, 3x                                    â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  P1 (High):         Transactional (order confirmation, shipping)            â”‚   â”‚
â”‚  â”‚                     SLA: < 1 minute                                          â”‚   â”‚
â”‚  â”‚                     Retry: 1 min, 5 min, 15 min                             â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  P2 (Medium):       Social (likes, comments, follows)                       â”‚   â”‚
â”‚  â”‚                     SLA: < 5 minutes                                         â”‚   â”‚
â”‚  â”‚                     Retry: 5 min, 30 min                                    â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  P3 (Low):          Marketing, recommendations                              â”‚   â”‚
â”‚  â”‚                     SLA: < 1 hour                                            â”‚   â”‚
â”‚  â”‚                     Retry: 1 hour, 4 hours                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  Kafka Topic Structure:                                                             â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  Topic: notifications.p0                                                    â”‚   â”‚
â”‚  â”‚  Partitions: 100                                                            â”‚   â”‚
â”‚  â”‚  Retention: 1 hour                                                          â”‚   â”‚
â”‚  â”‚  Consumer groups: 50 workers (instant processing)                           â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  Topic: notifications.p1                                                    â”‚   â”‚
â”‚  â”‚  Partitions: 200                                                            â”‚   â”‚
â”‚  â”‚  Retention: 6 hours                                                         â”‚   â”‚
â”‚  â”‚  Consumer groups: 100 workers                                               â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  Topic: notifications.p2                                                    â”‚   â”‚
â”‚  â”‚  Partitions: 100                                                            â”‚   â”‚
â”‚  â”‚  Retention: 24 hours                                                        â”‚   â”‚
â”‚  â”‚  Consumer groups: 50 workers                                                â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  Topic: notifications.p3                                                    â”‚   â”‚
â”‚  â”‚  Partitions: 50                                                             â”‚   â”‚
â”‚  â”‚  Retention: 7 days                                                          â”‚   â”‚
â”‚  â”‚  Consumer groups: 20 workers (can be throttled)                             â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  Worker Allocation:                                                                 â”‚
â”‚  - P0: Dedicated workers, always at max capacity                                   â”‚
â”‚  - P1-P3: Shared pool, priority-based scheduling                                   â”‚
â”‚  - Auto-scale based on queue depth                                                 â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation:**

```python
class NotificationRouter:
    def __init__(self):
        self.kafka = KafkaProducer()
        self.priority_config = {
            "otp": 0, "security": 0, "payment_failed": 0,
            "order": 1, "shipping": 1, "delivery": 1,
            "like": 2, "comment": 2, "follow": 2,
            "marketing": 3, "recommendation": 3
        }
    
    async def route(self, notification: Notification):
        priority = self.priority_config.get(notification.type, 2)
        topic = f"notifications.p{priority}"
        
        await self.kafka.send(
            topic=topic,
            key=notification.user_id,  # Partition by user for ordering
            value=notification.to_json(),
            headers={"priority": str(priority)}
        )
    
    async def batch_route(self, notifications: List[Notification]):
        # Group by priority
        by_priority = defaultdict(list)
        for n in notifications:
            priority = self.priority_config.get(n.type, 2)
            by_priority[priority].append(n)
        
        # Send in batches
        for priority, batch in by_priority.items():
            topic = f"notifications.p{priority}"
            await self.kafka.send_batch(topic, batch)
```

### 2. Rate Limiting and Throttling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          RATE LIMITING                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  Rate Limit Levels:                                                                 â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  1. Per User:                                                               â”‚   â”‚
â”‚  â”‚     - Push: 100/hour                                                        â”‚   â”‚
â”‚  â”‚     - Email: 20/hour                                                        â”‚   â”‚
â”‚  â”‚     - SMS: 10/hour                                                          â”‚   â”‚
â”‚  â”‚     Purpose: Prevent spam, user experience                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  2. Per Sender (Service):                                                   â”‚   â”‚
â”‚  â”‚     - Max 1M/hour per service                                               â”‚   â”‚
â”‚  â”‚     - Burst: 10K/second                                                     â”‚   â”‚
â”‚  â”‚     Purpose: Protect system, fair usage                                     â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  3. Per Channel:                                                             â”‚   â”‚
â”‚  â”‚     - APNs: Follow Apple guidelines                                         â”‚   â”‚
â”‚  â”‚     - Email: Reputation-based limits                                        â”‚   â”‚
â”‚  â”‚     - SMS: Provider limits + cost control                                   â”‚   â”‚
â”‚  â”‚     Purpose: Provider compliance, cost                                      â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  4. Global:                                                                  â”‚   â”‚
â”‚  â”‚     - Emergency brake: 50M/hour                                             â”‚   â”‚
â”‚  â”‚     Purpose: System protection                                              â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  Implementation (Token Bucket):                                                     â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  Redis-based rate limiter:                                                  â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  Key: rate_limit:{user_id}:{channel}                                       â”‚   â”‚
â”‚  â”‚  Value: {tokens: 50, last_refill: timestamp}                               â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  def check_rate_limit(user_id, channel):                                   â”‚   â”‚
â”‚  â”‚      key = f"rate_limit:{user_id}:{channel}"                               â”‚   â”‚
â”‚  â”‚      bucket = redis.get(key)                                               â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      # Refill tokens based on time passed                                  â”‚   â”‚
â”‚  â”‚      elapsed = now() - bucket.last_refill                                  â”‚   â”‚
â”‚  â”‚      refill = elapsed * refill_rate                                        â”‚   â”‚
â”‚  â”‚      bucket.tokens = min(max_tokens, bucket.tokens + refill)               â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚      if bucket.tokens >= 1:                                                â”‚   â”‚
â”‚  â”‚          bucket.tokens -= 1                                                â”‚   â”‚
â”‚  â”‚          redis.set(key, bucket)                                            â”‚   â”‚
â”‚  â”‚          return ALLOWED                                                     â”‚   â”‚
â”‚  â”‚      else:                                                                  â”‚   â”‚
â”‚  â”‚          return RATE_LIMITED                                               â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  Rate-Limited Handling:                                                             â”‚
â”‚  - Queue for later delivery (if within SLA)                                        â”‚
â”‚  - Aggregate into digest (for marketing)                                           â”‚
â”‚  - Drop if expired                                                                  â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Template Rendering Engine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TEMPLATE ENGINE                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  Template Structure:                                                                â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  {                                                                           â”‚   â”‚
â”‚  â”‚    "template_id": "order_shipped",                                          â”‚   â”‚
â”‚  â”‚    "version": 3,                                                            â”‚   â”‚
â”‚  â”‚    "channels": {                                                            â”‚   â”‚
â”‚  â”‚      "push": {                                                              â”‚   â”‚
â”‚  â”‚        "title": "Order Shipped! ğŸ“¦",                                        â”‚   â”‚
â”‚  â”‚        "body": "Your order {{order_id}} is on its way!",                   â”‚   â”‚
â”‚  â”‚        "deep_link": "app://orders/{{order_id}}"                            â”‚   â”‚
â”‚  â”‚      },                                                                      â”‚   â”‚
â”‚  â”‚      "email": {                                                              â”‚   â”‚
â”‚  â”‚        "subject": "Your order is on its way",                              â”‚   â”‚
â”‚  â”‚        "template_file": "order_shipped.html",                               â”‚   â”‚
â”‚  â”‚        "from": "shipping@company.com"                                       â”‚   â”‚
â”‚  â”‚      },                                                                      â”‚   â”‚
â”‚  â”‚      "sms": {                                                               â”‚   â”‚
â”‚  â”‚        "body": "Order {{order_id}} shipped. Track: {{tracking_url}}"       â”‚   â”‚
â”‚  â”‚      }                                                                       â”‚   â”‚
â”‚  â”‚    },                                                                        â”‚   â”‚
â”‚  â”‚    "variables": ["order_id", "tracking_url", "estimated_delivery"],        â”‚   â”‚
â”‚  â”‚    "languages": ["en", "es", "fr", "de"]                                   â”‚   â”‚
â”‚  â”‚  }                                                                           â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  Rendering Pipeline:                                                                â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  1. Load template (with caching)                                            â”‚   â”‚
â”‚  â”‚  2. Select language variant                                                  â”‚   â”‚
â”‚  â”‚  3. Substitute variables                                                    â”‚   â”‚
â”‚  â”‚  4. Apply personalization rules                                             â”‚   â”‚
â”‚  â”‚  5. Validate output (length limits, encoding)                               â”‚   â”‚
â”‚  â”‚  6. Return rendered content                                                 â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation:**

```python
class TemplateEngine:
    def __init__(self):
        self.cache = LRUCache(maxsize=1000)
        self.jinja = jinja2.Environment(
            autoescape=True,
            undefined=jinja2.StrictUndefined
        )
    
    async def render(self, template_id: str, channel: str, 
                     variables: dict, language: str) -> RenderedContent:
        # Load template (cached)
        template = await self.load_template(template_id)
        
        # Get channel-specific template
        channel_template = template.channels.get(channel)
        if not channel_template:
            raise UnsupportedChannelError(channel)
        
        # Get language variant
        content = self.get_language_variant(channel_template, language)
        
        # Render with Jinja2
        rendered = {}
        for key, value in content.items():
            if isinstance(value, str):
                jinja_template = self.jinja.from_string(value)
                rendered[key] = jinja_template.render(**variables)
            else:
                rendered[key] = value
        
        # Validate
        self.validate_output(channel, rendered)
        
        return RenderedContent(channel=channel, content=rendered)
    
    def validate_output(self, channel: str, content: dict):
        limits = {
            "push": {"title": 65, "body": 240},
            "sms": {"body": 160},  # Per segment
            "email": {"subject": 200}
        }
        
        for field, max_length in limits.get(channel, {}).items():
            if field in content and len(content[field]) > max_length:
                # Truncate or raise error based on config
                content[field] = content[field][:max_length-3] + "..."
```

### 4. Delivery Tracking and Analytics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DELIVERY TRACKING                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  Event Types:                                                                       â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  CREATED    â†’ Notification received by system                               â”‚   â”‚
â”‚  â”‚  QUEUED     â†’ Added to delivery queue                                       â”‚   â”‚
â”‚  â”‚  PROCESSING â†’ Being processed by worker                                     â”‚   â”‚
â”‚  â”‚  SENT       â†’ Handed off to provider                                        â”‚   â”‚
â”‚  â”‚  DELIVERED  â†’ Provider confirmed delivery                                   â”‚   â”‚
â”‚  â”‚  OPENED     â†’ User opened (email/push)                                      â”‚   â”‚
â”‚  â”‚  CLICKED    â†’ User clicked link                                             â”‚   â”‚
â”‚  â”‚  FAILED     â†’ Delivery failed                                               â”‚   â”‚
â”‚  â”‚  BOUNCED    â†’ Email bounced                                                 â”‚   â”‚
â”‚  â”‚  UNSUBSCRIBED â†’ User unsubscribed                                           â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  Event Schema (ClickHouse):                                                         â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â”‚  CREATE TABLE notification_events (                                         â”‚   â”‚
â”‚  â”‚    notification_id UUID,                                                    â”‚   â”‚
â”‚  â”‚    user_id UInt64,                                                          â”‚   â”‚
â”‚  â”‚    event_type Enum(...),                                                    â”‚   â”‚
â”‚  â”‚    channel Enum('push', 'email', 'sms', 'in_app'),                         â”‚   â”‚
â”‚  â”‚    notification_type String,                                                â”‚   â”‚
â”‚  â”‚    timestamp DateTime,                                                       â”‚   â”‚
â”‚  â”‚    metadata String,  -- JSON                                                â”‚   â”‚
â”‚  â”‚    sender_service String                                                    â”‚   â”‚
â”‚  â”‚  ) ENGINE = MergeTree()                                                     â”‚   â”‚
â”‚  â”‚  PARTITION BY toYYYYMM(timestamp)                                           â”‚   â”‚
â”‚  â”‚  ORDER BY (notification_type, channel, timestamp);                          â”‚   â”‚
â”‚  â”‚                                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  Metrics Computed:                                                                  â”‚
â”‚                                                                                     â”‚
â”‚  - Delivery rate: DELIVERED / SENT                                                 â”‚
â”‚  - Open rate: OPENED / DELIVERED                                                   â”‚
â”‚  - Click rate: CLICKED / OPENED                                                    â”‚
â”‚  - Bounce rate: BOUNCED / SENT (email)                                            â”‚
â”‚  - Unsubscribe rate: UNSUBSCRIBED / DELIVERED                                      â”‚
â”‚  - Latency: AVG(DELIVERED.timestamp - CREATED.timestamp)                          â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Trade-offs and Tech Choices

### 1. At-least-once vs Exactly-once Delivery

| Approach | Pros | Cons |
|----------|------|------|
| At-least-once | Simple, reliable | Possible duplicates |
| Exactly-once | No duplicates | Complex, slower |

**Decision:** At-least-once with idempotency keys for critical notifications

### 2. Push vs Pull for In-App

| Approach | Use Case | Implementation |
|----------|----------|----------------|
| Push (WebSocket) | Real-time, active users | More resources |
| Pull (Polling) | Background, battery-sensitive | Higher latency |
| Hybrid | Best of both | Complex |

**Decision:** WebSocket for active sessions, poll for background

### 3. Provider Selection

| Channel | Primary | Backup | Criteria |
|---------|---------|--------|----------|
| Push | FCM/APNs | - | Required |
| Email | SendGrid | SES | Deliverability, cost |
| SMS | Twilio | Nexmo | Coverage, cost |

### 4. Batching Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BATCHING DECISIONS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  When to batch:                                                  â”‚
â”‚  - High-frequency social notifications (likes)                  â”‚
â”‚  - Marketing emails (daily digest)                              â”‚
â”‚  - Non-urgent system notifications                              â”‚
â”‚                                                                 â”‚
â”‚  When NOT to batch:                                              â”‚
â”‚  - Security notifications (OTP, login alerts)                   â”‚
â”‚  - Transactional (order confirmation)                           â”‚
â”‚  - Time-sensitive (auction ending)                              â”‚
â”‚                                                                 â”‚
â”‚  Batching strategies:                                            â”‚
â”‚  - Time-based: Every 5 minutes                                  â”‚
â”‚  - Count-based: Every 10 notifications                          â”‚
â”‚  - Hybrid: Whichever comes first                                â”‚
â”‚  - Smart: ML-based optimal timing                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Failure Scenarios and Bottlenecks

### 1. Provider Outage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                PROVIDER FAILOVER                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Detection:                                                      â”‚
â”‚  - Health check failures (3 consecutive)                        â”‚
â”‚  - Error rate > 5%                                              â”‚
â”‚  - Latency > 5 seconds                                          â”‚
â”‚                                                                 â”‚
â”‚  Failover:                                                       â”‚
â”‚  1. Mark provider as unhealthy                                  â”‚
â”‚  2. Route new messages to backup                                â”‚
â”‚  3. Re-queue failed messages                                    â”‚
â”‚  4. Alert on-call team                                          â”‚
â”‚                                                                 â”‚
â”‚  Email failover example:                                         â”‚
â”‚  Primary: SendGrid (95% of traffic)                             â”‚
â”‚  Backup: AWS SES (5% + failover)                                â”‚
â”‚                                                                 â”‚
â”‚  Circuit breaker:                                                â”‚
â”‚  - Half-open after 5 minutes                                    â”‚
â”‚  - Send 10% traffic to test                                     â”‚
â”‚  - Close circuit if success rate > 95%                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Kafka Lag

```
Problem: Consumer lag > 1 million messages

Mitigation:
1. Auto-scale consumers based on lag
2. Increase partition count
3. Enable consumer group rebalancing
4. Temporary: Reduce processing per message

Monitoring:
- Alert at lag > 100K
- Critical at lag > 1M
- Page on-call at lag > 5M
```

### 3. Database Overload

```
Problem: Preference lookup latency > 100ms

Solutions:
1. Redis caching (99% hit rate target)
2. Read replicas for preferences
3. Local cache for hot preferences
4. Batch preference lookups

Cache warming:
- Pre-load active users' preferences
- Update cache on preference change
- Background refresh for expiring entries
```

### 4. Spam/Abuse

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ABUSE PREVENTION                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Detection:                                                      â”‚
â”‚  - Unusual volume from service                                  â”‚
â”‚  - Repetitive content patterns                                  â”‚
â”‚  - High bounce/complaint rates                                  â”‚
â”‚                                                                 â”‚
â”‚  Prevention:                                                     â”‚
â”‚  1. Service-level rate limits                                   â”‚
â”‚  2. Content fingerprinting (detect duplicates)                  â”‚
â”‚  3. User-level frequency caps                                   â”‚
â”‚  4. Manual review for new templates                             â”‚
â”‚                                                                 â”‚
â”‚  Response:                                                       â”‚
â”‚  - Auto-throttle suspicious services                            â”‚
â”‚  - Queue for manual review                                      â”‚
â”‚  - Block known spam patterns                                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Future Improvements

### 1. ML-Based Optimization

- Optimal send time prediction
- Channel preference learning
- Content personalization
- Engagement prediction

### 2. Rich Notifications

- Interactive buttons (reply, snooze)
- Rich media (images, carousels)
- Progressive disclosure
- Live activities (iOS)

### 3. Cross-Channel Orchestration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                INTELLIGENT ROUTING                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Scenario: Order confirmation                                   â”‚
â”‚                                                                 â”‚
â”‚  Step 1: Send push notification                                 â”‚
â”‚  Step 2: Wait 30 minutes                                        â”‚
â”‚  Step 3: If not opened â†’ Send email                            â”‚
â”‚  Step 4: Wait 2 hours                                           â”‚
â”‚  Step 5: If not opened â†’ Send SMS                              â”‚
â”‚                                                                 â”‚
â”‚  Benefits:                                                       â”‚
â”‚  - Reduce notification fatigue                                  â”‚
â”‚  - Use cheapest channel that works                              â”‚
â”‚  - Respect user preferences                                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Interviewer Questions & Answers

### Q1: How do you ensure notifications are delivered reliably?

**Answer:**

**Multi-layer reliability:**

1. **At-least-once delivery:**
   - Don't acknowledge Kafka message until provider confirms
   - Use idempotency keys to prevent duplicates
   ```python
   def send_notification(notification):
       idempotency_key = f"{notification.id}:{notification.channel}"
       if redis.exists(f"sent:{idempotency_key}"):
           return  # Already sent
       
       result = provider.send(notification)
       if result.success:
           redis.setex(f"sent:{idempotency_key}", 86400, "1")
           kafka.commit()
   ```

2. **Retry with exponential backoff:**
   ```python
   retry_delays = [1, 5, 15, 60, 300]  # seconds
   
   def send_with_retry(notification, attempt=0):
       try:
           provider.send(notification)
       except ProviderError as e:
           if attempt < len(retry_delays):
               schedule_retry(notification, retry_delays[attempt])
           else:
               move_to_dlq(notification)
   ```

3. **Provider failover:**
   - Multiple providers per channel
   - Circuit breaker pattern
   - Auto-failover on degradation

4. **Dead letter queue:**
   - Failed notifications saved for analysis
   - Manual retry capability
   - Alerting on DLQ growth

---

### Q2: How do you handle 10 billion notifications per day?

**Answer:**

**Architecture for scale:**

1. **Horizontal scaling:**
   - Stateless workers (scale to 1000+)
   - Kafka partitions (1000+) for parallelism
   - Sharded databases by user_id

2. **Batching:**
   ```python
   class BatchProcessor:
       def __init__(self):
           self.batch = []
           self.batch_size = 1000
           self.flush_interval = 100  # ms
       
       async def add(self, notification):
           self.batch.append(notification)
           if len(self.batch) >= self.batch_size:
               await self.flush()
       
       async def flush(self):
           # Batch API calls to providers
           await provider.send_batch(self.batch)
           self.batch = []
   ```

3. **Async processing:**
   - API returns immediately (202 Accepted)
   - Background workers process queues
   - Non-blocking I/O throughout

4. **Caching:**
   - User preferences: 99% cache hit
   - Templates: In-memory cache
   - Device tokens: Redis cache

**Capacity planning:**
- 10B/day = 115K/sec average
- Peak: 350K/sec
- Workers needed: 350K / 1K per worker = 350 workers minimum

---

### Q3: How do you implement user notification preferences?

**Answer:**

**Data model:**
```python
class NotificationPreferences:
    user_id: str
    
    # Channel preferences
    email_enabled: bool = True
    push_enabled: bool = True
    sms_enabled: bool = True
    
    # Category preferences
    categories: Dict[str, ChannelPrefs] = {
        "marketing": {"email": True, "push": False, "sms": False},
        "social": {"email": False, "push": True, "sms": False},
        "transactional": {"email": True, "push": True, "sms": True}
    }
    
    # Timing preferences
    quiet_hours: Optional[QuietHours] = QuietHours(start="22:00", end="08:00")
    timezone: str = "America/New_York"
    
    # Frequency caps
    max_per_day: Dict[str, int] = {"push": 20, "email": 5, "sms": 2}
    
    # Digest preferences
    digest_enabled: bool = True
    digest_time: str = "09:00"
```

**Preference check flow:**
```python
async def should_send(user_id: str, notification: Notification) -> Decision:
    prefs = await get_preferences(user_id)  # Cached
    
    # Check channel enabled
    if not prefs.channel_enabled(notification.channel):
        return Decision.SKIP
    
    # Check category allowed
    if not prefs.category_allowed(notification.category, notification.channel):
        return Decision.SKIP
    
    # Check quiet hours
    if prefs.in_quiet_hours():
        return Decision.QUEUE_FOR_LATER
    
    # Check frequency cap
    today_count = await get_today_count(user_id, notification.channel)
    if today_count >= prefs.max_per_day[notification.channel]:
        return Decision.RATE_LIMITED
    
    return Decision.SEND
```

---

### Q4: How do you handle push notification tokens?

**Answer:**

**Token management:**
```python
class DeviceTokenService:
    async def register_token(self, user_id: str, device_id: str, 
                             token: str, platform: str):
        # Store token
        await db.upsert("device_tokens", {
            "user_id": user_id,
            "device_id": device_id,
            "token": token,
            "platform": platform,  # ios, android, web
            "created_at": datetime.now(),
            "last_used": datetime.now()
        })
        
        # Invalidate cache
        await cache.delete(f"tokens:{user_id}")
    
    async def get_tokens(self, user_id: str) -> List[DeviceToken]:
        # Check cache
        cached = await cache.get(f"tokens:{user_id}")
        if cached:
            return cached
        
        # Load from DB
        tokens = await db.query(
            "SELECT * FROM device_tokens WHERE user_id = %s",
            user_id
        )
        
        # Cache for 1 hour
        await cache.setex(f"tokens:{user_id}", 3600, tokens)
        return tokens
    
    async def handle_invalid_token(self, user_id: str, token: str):
        # Remove invalid token
        await db.delete("device_tokens", {"token": token})
        await cache.delete(f"tokens:{user_id}")
```

**Token refresh handling:**
- iOS: APNs returns new token, update immediately
- Android: FCM token can change, handle onTokenRefresh

**Multi-device:**
- Send to all active devices
- Track engagement per device
- Prune inactive devices (>30 days)

---

### Q5: How do you implement email deliverability?

**Answer:**

**Email best practices:**

1. **Authentication:**
   ```
   SPF: Authorize sending IPs
   DKIM: Sign emails cryptographically
   DMARC: Policy for failed authentication
   ```

2. **List hygiene:**
   ```python
   class EmailHygiene:
       async def check_address(self, email: str) -> EmailStatus:
           # Check bounce history
           if await self.is_bounced(email):
               return EmailStatus.HARD_BOUNCE
           
           # Check complaint history
           if await self.is_complained(email):
               return EmailStatus.COMPLAINED
           
           # Check engagement (opened in last 90 days)
           if not await self.has_engaged(email, days=90):
               return EmailStatus.INACTIVE
           
           return EmailStatus.ACTIVE
       
       async def process_bounce(self, email: str, bounce_type: str):
           if bounce_type == "hard":
               # Permanent - mark as invalid
               await self.mark_invalid(email)
           elif bounce_type == "soft":
               # Temporary - retry later
               await self.increment_soft_bounce(email)
               if await self.soft_bounce_count(email) > 3:
                   await self.mark_invalid(email)
   ```

3. **Warming:**
   - Gradually increase volume for new IPs
   - Start with engaged users
   - Monitor reputation metrics

4. **Monitoring:**
   - Bounce rate < 2%
   - Complaint rate < 0.1%
   - Inbox placement rate > 95%

---

### Q6: How do you handle SMS delivery globally?

**Answer:**

**Multi-provider strategy:**
```python
class SMSRouter:
    def __init__(self):
        self.providers = {
            "US": ["twilio", "nexmo"],
            "IN": ["gupshup", "twilio"],
            "EU": ["nexmo", "twilio"],
            "default": ["twilio"]
        }
        self.costs = {
            "twilio_US": 0.0075,
            "nexmo_US": 0.0065,
            # ...
        }
    
    def select_provider(self, country: str, priority: str):
        providers = self.providers.get(country, self.providers["default"])
        
        if priority == "high":
            # Use most reliable (first in list)
            return providers[0]
        else:
            # Use cheapest
            return min(providers, key=lambda p: self.costs[f"{p}_{country}"])
```

**Considerations:**
- Sender ID registration per country
- DLT registration (India)
- Opt-out compliance (TCPA, GDPR)
- Time zone awareness

**Cost optimization:**
- Use long codes for marketing
- Short codes for time-sensitive
- Batch messages where possible

---

### Q7: How do you implement notification analytics?

**Answer:**

**Event tracking:**
```python
class NotificationAnalytics:
    def __init__(self):
        self.clickhouse = ClickHouse()
        self.kafka = KafkaProducer()
    
    async def track_event(self, event: NotificationEvent):
        # Write to Kafka for real-time
        await self.kafka.send("notification_events", event)
    
    async def get_metrics(self, filters: MetricFilters) -> Metrics:
        query = """
            SELECT
                notification_type,
                channel,
                countIf(event_type = 'sent') as sent,
                countIf(event_type = 'delivered') as delivered,
                countIf(event_type = 'opened') as opened,
                countIf(event_type = 'clicked') as clicked,
                avg(if(event_type = 'delivered', 
                    timestamp - sent_timestamp, null)) as avg_delivery_time
            FROM notification_events
            WHERE timestamp BETWEEN {start} AND {end}
            GROUP BY notification_type, channel
        """
        return await self.clickhouse.query(query, filters)
```

**Open/click tracking:**
```python
# Email open tracking (pixel)
def generate_tracking_pixel(notification_id: str) -> str:
    token = encrypt(notification_id)
    return f'<img src="https://track.company.com/open/{token}" width="1" height="1"/>'

# Click tracking (redirect)
def wrap_link(original_url: str, notification_id: str) -> str:
    token = encrypt(f"{notification_id}:{original_url}")
    return f"https://track.company.com/click/{token}"

# Tracking endpoint
@app.get("/click/{token}")
async def track_click(token: str):
    notification_id, original_url = decrypt(token)
    await analytics.track_event(NotificationEvent(
        notification_id=notification_id,
        event_type="clicked"
    ))
    return RedirectResponse(original_url)
```

---

### Q8: How do you handle notification deduplication?

**Answer:**

**Deduplication strategies:**

1. **Idempotency key:**
   ```python
   async def is_duplicate(notification: Notification) -> bool:
       key = f"dedup:{notification.user_id}:{notification.type}:{notification.content_hash}"
       
       # Check if sent recently (1 hour window)
       if await redis.exists(key):
           return True
       
       # Mark as sent
       await redis.setex(key, 3600, "1")
       return False
   ```

2. **Content-based dedup:**
   ```python
   def content_hash(notification: Notification) -> str:
       # Hash meaningful content
       content = f"{notification.type}:{notification.data}"
       return hashlib.md5(content.encode()).hexdigest()[:8]
   ```

3. **Aggregation:**
   ```python
   async def aggregate_social_notifications(user_id: str):
       # Instead of "John liked your post" x10
       # Send "John and 9 others liked your post"
       
       pending = await redis.lrange(f"pending_likes:{user_id}", 0, -1)
       
       if len(pending) >= 3:
           names = [p.actor_name for p in pending[:3]]
           others = len(pending) - 3
           message = f"{', '.join(names)} and {others} others liked your post"
           
           await send_notification(user_id, message)
           await redis.delete(f"pending_likes:{user_id}")
   ```

---

### Q9: How do you implement quiet hours?

**Answer:**

**Implementation:**
```python
class QuietHoursService:
    async def check_quiet_hours(self, user_id: str, 
                                notification: Notification) -> QuietHoursResult:
        prefs = await get_preferences(user_id)
        
        if not prefs.quiet_hours:
            return QuietHoursResult(blocked=False)
        
        # Convert to user's timezone
        user_tz = pytz.timezone(prefs.timezone)
        user_time = datetime.now(user_tz)
        
        # Check if in quiet period
        start = time.fromisoformat(prefs.quiet_hours.start)
        end = time.fromisoformat(prefs.quiet_hours.end)
        
        if self.is_in_range(user_time.time(), start, end):
            # Check if notification is exempt
            if notification.priority == "critical":
                return QuietHoursResult(blocked=False)
            
            # Calculate when to deliver
            if end < start:  # Crosses midnight
                deliver_at = user_time.replace(
                    hour=end.hour, minute=end.minute
                ) + timedelta(days=1)
            else:
                deliver_at = user_time.replace(
                    hour=end.hour, minute=end.minute
                )
            
            return QuietHoursResult(
                blocked=True,
                deliver_at=deliver_at
            )
        
        return QuietHoursResult(blocked=False)
```

**Handling blocked notifications:**
- Queue for later delivery
- Aggregate into digest
- Allow critical notifications through

---

### Q10: How do you handle notification failures and retries?

**Answer:**

**Retry strategy:**
```python
class RetryHandler:
    RETRY_DELAYS = {
        "push": [60, 300, 900],        # 1m, 5m, 15m
        "email": [300, 1800, 7200],    # 5m, 30m, 2h
        "sms": [60, 300, 600]          # 1m, 5m, 10m
    }
    
    async def handle_failure(self, notification: Notification, 
                             error: Exception, attempt: int):
        channel = notification.channel
        delays = self.RETRY_DELAYS[channel]
        
        # Determine if retryable
        if isinstance(error, PermanentError):
            # Invalid token, bounced email, etc.
            await self.mark_permanent_failure(notification, error)
            return
        
        if attempt >= len(delays):
            # Max retries exceeded
            await self.move_to_dlq(notification, error)
            await self.alert_if_critical(notification)
            return
        
        # Schedule retry
        delay = delays[attempt]
        await self.schedule_retry(notification, delay, attempt + 1)
    
    async def schedule_retry(self, notification: Notification, 
                             delay: int, attempt: int):
        notification.retry_attempt = attempt
        notification.scheduled_at = datetime.now() + timedelta(seconds=delay)
        
        await kafka.send(
            topic=f"notifications.retry.{notification.channel}",
            value=notification,
            timestamp_ms=(datetime.now() + timedelta(seconds=delay)).timestamp() * 1000
        )
```

**Dead letter queue handling:**
- Store failed notifications with error details
- Dashboard for manual review
- Bulk retry capability
- Alerting on DLQ growth

---

### Bonus: Quick Architecture Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           NOTIFICATION SYSTEM - FINAL ARCHITECTURE               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Scale: 10B notifications/day, 500K/sec peak                   â”‚
â”‚                                                                 â”‚
â”‚  Core Components:                                               â”‚
â”‚  â”œâ”€â”€ API Gateway - Validation, rate limiting                   â”‚
â”‚  â”œâ”€â”€ Priority Queues (Kafka) - P0-P3 queues                    â”‚
â”‚  â”œâ”€â”€ Notification Processor - Preferences, templating          â”‚
â”‚  â”œâ”€â”€ Channel Router - Multi-channel delivery                   â”‚
â”‚  â”œâ”€â”€ Delivery Workers - Provider integration                   â”‚
â”‚  â””â”€â”€ Analytics Pipeline - Tracking, metrics                    â”‚
â”‚                                                                 â”‚
â”‚  Data Stores:                                                   â”‚
â”‚  â”œâ”€â”€ Cassandra - Notification history                          â”‚
â”‚  â”œâ”€â”€ Redis - Preferences cache, rate limits                    â”‚
â”‚  â”œâ”€â”€ PostgreSQL - Templates, user data                         â”‚
â”‚  â””â”€â”€ ClickHouse - Analytics                                    â”‚
â”‚                                                                 â”‚
â”‚  Key Decisions:                                                 â”‚
â”‚  â”œâ”€â”€ Priority-based queuing (P0-P3)                            â”‚
â”‚  â”œâ”€â”€ At-least-once delivery with idempotency                   â”‚
â”‚  â”œâ”€â”€ Multi-provider failover per channel                       â”‚
â”‚  â”œâ”€â”€ User preference-driven routing                            â”‚
â”‚  â”œâ”€â”€ Batching for high-frequency notifications                 â”‚
â”‚  â””â”€â”€ Comprehensive analytics pipeline                          â”‚
â”‚                                                                 â”‚
â”‚  SLA: 99.99% availability, <1 min for P0-P1                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
